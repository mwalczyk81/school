@page "/"

@using Weather.Models
@using Weather.Services

@inject WeatherService WeatherService
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar

<title>Weather Forecast</title>
<MudText Typo="Typo.h4" GutterBottom="true" Align="Align.Center">Weather Forecast</MudText>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-6">
    <MudPaper Class="pa-4" Elevation="3">
        <MudGrid Justify="Justify.SpaceBetween" Class="mb-4">
            <MudItem xs="12" sm="8">
                <MudAutocomplete @bind-Value="SelectedCity"
                                 Label="City"
                                 Variant="Variant.Text"
                                 Placeholder="Enter city"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.LocationCity"
                                 AdornmentColor="Color.Primary"
                                 IconSize="Size.Medium"
                                 Immediate="true"
                                 ToStringFunc="(city) => city?.DisplayName"
                                 MinCharacters="2"
                                 OnClearButtonClick="ClearSelectedCity"
                                 SearchFunc="@SearchCitySuggestions"
                                 Clearable="true" 
                                 TextChanged="OnInputTextChanged" />
            </MudItem>
            <MudItem xs="12" sm="4" Class="d-flex justify-end">
                <MudButton OnClick="GetWeatherAsync"
                           Disabled="@(SelectedCity == null || isLoading)"
                           Color="Color.Primary"
                           Variant="Variant.Filled"
                           Size="Size.Small"
                           Class="mx-2"
                           AriaLabel="Get Weather">
                    Get Weather
                </MudButton>
                <MudIconButton OnClick="GetWeatherByLocationAsync"
                               Color="Color.Primary"
                               Variant="Variant.Filled"
                               Icon="@Icons.Material.Filled.MyLocation"
                               Size="Size.Large"
                               AriaLabel="Get Weather by Location" />
            </MudItem>
        </MudGrid>

        @if (isLoading)
        {
            <MudSkeleton Width="100%" Height="200px" Class="mb-3" />
        }
        else if (currentWeather != null && dailySummary != null)
        {
            <!-- Current Weather Section -->
            <MudPaper Class="pa-4 mt-5" Elevation="2">
                <MudText Align="Align.Center" Typo="Typo.h5">@currentWeather.Name</MudText>
                <MudStack Spacing="2" AlignItems="AlignItems.Center">
                    <MudAvatar Size="Size.Large" Class="weather-icon">
                        <MudImage Src="@GetIconUrl(currentWeather.Weather?[0].Icon ?? "")" Alt="@currentWeather.Weather?[0].Description" />
                    </MudAvatar>
                    <MudText Typo="Typo.h6">@currentWeather.Main?.Temp°F</MudText>
                    <MudText Typo="Typo.h6">Humidity @currentWeather.Main?.Humidity%</MudText>
                    <MudText Typo="Typo.subtitle2">@currentWeather.Weather?[0].Description</MudText>
                </MudStack>
            </MudPaper>

            <!-- 5-Day Forecast Section -->
            <MudText Typo="Typo.h6" GutterBottom="true" Class="mt-4">5-Day Forecast:</MudText>
            <MudGrid Spacing="3">
                @foreach (var day in dailySummary)
                {
                    <MudItem xs="12" sm="6" md="4" lg="3">
                        <MudPaper Class="pa-2 forecast-card"
                                  Elevation="2"
                                  Style="cursor: pointer;"
                                  @onclick="() => ToggleDay(day.Key)">
                            <MudStack Spacing="2" AlignItems="AlignItems.Center">
                                <MudAvatar Size="Size.Medium" Class="weather-icon">
                                    <MudImage Src="@GetIconUrl(day.Value.Icon ?? "")" Alt="@day.Value.Icon" />
                                </MudAvatar>
                                <MudText Typo="Typo.subtitle1">@DateTime.Parse(day.Key).ToString("dddd MMM d")</MudText>
                                <MudText Typo="Typo.body2">High: @day.Value.High°F</MudText>
                                <MudText Typo="Typo.body2">Low: @day.Value.Low°F</MudText>
                            </MudStack>

                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>

            <!-- Hourly Forecast Expanded Section -->
            @if (!string.IsNullOrEmpty(expandedDay))
            {
                <MudPaper Class="pa-4 mt-4 mud-animate-fadein" Elevation="1">
                    <MudText Typo="Typo.h6">Hourly Forecast for @DateTime.Parse(expandedDay).ToString("dddd MMM d"):</MudText>
                    <MudGrid Spacing="3">
                        @if (dailySummary.ContainsKey(expandedDay) && dailySummary[expandedDay]?.Details is not null)
                        {
                            @foreach (var hourly in dailySummary[expandedDay].Details!)
                            {
                                <MudItem xs="12" sm="6" md="4" lg="2">
                                    <MudPaper Class="pa-2" Elevation="1" Style="text-align: center;">
                                        <MudText Typo="Typo.caption">@DateTime.Parse(hourly.Dt_Txt ?? "").ToString("h:mm tt")</MudText>
                                        <br />
                                        <MudAvatar Size="Size.Small">
                                            <MudImage Src="@GetIconUrl(hourly.Weather?[0]?.Icon ?? "")" Alt="@hourly.Weather?[0]?.Description" />
                                        </MudAvatar>
                                        <MudText Typo="Typo.body2">@hourly.Main?.Temp°F</MudText>
                                        <MudText Typo="Typo.caption">@hourly.Weather?[0]?.Description</MudText>
                                    </MudPaper>
                                </MudItem>
                            }
                        }
                    </MudGrid>
                </MudPaper>
            }
        }
    </MudPaper>
</MudContainer>

@code {
    private string City = "";
    private CitySuggestion? SelectedCity { get; set; }
    private WeatherData? currentWeather;
    private Dictionary<string, DailyForecast>? dailySummary;
    private string? errorMessage;
    private string expandedDay = ""; // Track the currently expanded day
    private bool isLoading = false;

    private void ClearSelectedCity()
    {
        SelectedCity = null;
    }

    private void OnInputTextChanged(string input)
    {
        City = input;

        // If the input text is cleared or no valid city is selected, reset SelectedCity to null
        if (string.IsNullOrWhiteSpace(input))
        {
            SelectedCity = null;
        }
    }

    private async Task<IEnumerable<CitySuggestion>>? SearchCitySuggestions(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            SelectedCity = null;
            return [];
        }

        // Logic to fetch city suggestions
        return await WeatherService.GetCitySuggestionsAsync(value, WeatherService.GetOptions(), cancellationToken);
    }

    private async Task GetWeatherAsync()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            if(SelectedCity is not null)
            {
                (currentWeather, dailySummary, errorMessage) = await WeatherService.GetWeatherAsync(lat: double.Parse(SelectedCity.Lat), lon: double.Parse(SelectedCity.Lng));
            }
            else
            {
                (currentWeather, dailySummary, errorMessage) = await WeatherService.GetWeatherAsync(City);                
            }

            if (!string.IsNullOrEmpty(errorMessage))
            {
                Snackbar.Add(errorMessage, Severity.Error);
            }

            expandedDay = ""; // Reset expanded day when new data is fetched
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
            Snackbar.Add(errorMessage, Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task GetWeatherByLocationAsync()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            // Call JavaScript to get the user's location (lat/lon)
            var location = await JSRuntime.InvokeAsync<Location>("getUserLocation");

            // Fetch weather data using the user's latitude and longitude
            (currentWeather, dailySummary, errorMessage) = await WeatherService.GetWeatherAsync(lat: location.Lat, lon: location.Lon);

            if (!string.IsNullOrEmpty(errorMessage))
            {
                Snackbar.Add(errorMessage, Severity.Error);
            }

            expandedDay = ""; // Reset expanded day when new data is fetched
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to retrieve location: {ex.Message}";
            Snackbar.Add(errorMessage, Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ToggleDay(string day) => expandedDay = expandedDay == day ? "" : day; // Toggle the expanded day

    private string GetIconUrl(string icon) => $"https://openweathermap.org/img/wn/{icon}.png";
}